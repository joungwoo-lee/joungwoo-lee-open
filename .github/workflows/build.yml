name: Build and publish sandboxdocker tar (LFS + single-latest)

on:
  push:
    branches: [ main ]

permissions:
  contents: write

concurrency:
  group: publish-sandboxdocker
  cancel-in-progress: false

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Ensure Git LFS is available
        uses: actions/setup-git-lfs@v1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 레포 루트의 Dockerfile로 베이스 이미지 빌드
      - name: Build base image from repo Dockerfile
        run: |
          docker build -f Dockerfile -t baseimg:sandbox .

      # startrun.sh를 /root에 복사하는 오버레이 이미지 빌드
      - name: Create CI overlay Dockerfile to add startrun.sh
        run: |
          cat > Dockerfile.ci <<'EOF'
          FROM baseimg:sandbox
          COPY startrun.sh /root/startrun.sh
          RUN chmod +x /root/startrun.sh || true
          EOF

      - name: Build final image with startrun.sh at /root
        run: |
          docker build -f Dockerfile.ci -t sandboxdocker:latest .

      - name: Export image to sandboxdocker.tar
        run: |
          docker save sandboxdocker:latest -o sandboxdocker.tar
          ls -lh sandboxdocker.tar
          test -f sandboxdocker.tar

      # ===== 여기부터: 원본과 동일한 보관정책/브랜치처리/LFS 적용 =====
      - name: Set git identity
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Publish to build branch (LFS, keep only latest tar)
        env:
          TARGET_BRANCH: build
          TAR_NAME: sandboxdocker.tar
        run: |
          set -euxo pipefail

          # 산출물 존재 확인
          test -f "${GITHUB_WORKSPACE}/${TAR_NAME}"

          # 최신 원격 상태 반영
          git fetch origin

          # build 브랜치 체크아웃 (없으면 orphan으로 생성)
          if git rev-parse --verify "origin/${TARGET_BRANCH}" >/dev/null 2>&1; then
            git checkout -B "${TARGET_BRANCH}" "origin/${TARGET_BRANCH}"
          else
            git checkout --orphan "${TARGET_BRANCH}"
            git rm -rf . >/dev/null 2>&1 || true
          fi

          # .git만 남기고 모두 삭제 → 최신본만 유지 정책
          find . -mindepth 1 -maxdepth 1 ! -name ".git" -exec rm -rf {} +

          # LFS 초기화 및 패턴 설정(.gitattributes는 build 브랜치에 기록)
          git lfs install --local
          echo "*.tar filter=lfs diff=lfs merge=lfs -text" > .gitattributes

          # 빌드 산출물 복사 (Git에서 꺼내오지 말 것!)
          cp "${GITHUB_WORKSPACE}/${TAR_NAME}" "./${TAR_NAME}"

          # 커밋 & 강제 푸시(항상 최신본 한 개만 유지)
          git add .gitattributes "${TAR_NAME}"
          TS="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git commit -m "chore(build): update ${TAR_NAME} (${TS})" || echo "No changes to commit."
          git push origin "+HEAD:${TARGET_BRANCH}" --force

      - name: Summary
        run: |
          echo "✅ Published latest sandboxdocker.tar to 'build' branch with Git LFS (single-latest policy)."