# .github/workflows/build.yml
# Build with the repo's Dockerfile (root), then upload sandboxdocker.tar and docker-compose.yml to Release (tag=build-latest).
# Run:
#   wget https://github.com/joungwoo-lee/joungwoo-lee-open/releases/download/build-latest/sandboxdocker.tar
#   wget https://github.com/joungwoo-lee/joungwoo-lee-open/releases/download/build-latest/docker-compose.yml
#   docker load -i sandboxdocker.tar
#   docker compose up -d
# .github/workflows/build.yml
name: Publish Docker tar and compose to Release

on:
  push:
    branches: [ "main" ]
    paths:
      - "**"
      - ".github/workflows/build.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sanity check
        run: |
          set -euo pipefail
          test -f Dockerfile || { echo "Dockerfile not found at repo root"; exit 1; }
          ls -la || true

      - name: Build Docker image
        run: docker build -t sandboxdocker:latest .

      - name: Save image as tar
        run: |
          docker save sandboxdocker:latest -o sandboxdocker.tar
          ls -lh sandboxdocker.tar

      # ============ Docker Hub 배포 추가 ============
      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Tag and Push to Docker Hub
        if: github.event_name != 'pull_request'
        run: |
          # Docker Hub에 푸시할 이미지명 (사용자명/이미지명:태그)
          DOCKERHUB_IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/sandboxdocker:latest"
          
          # 로컬 이미지를 Docker Hub 태그로 태깅
          docker tag sandboxdocker:latest "$DOCKERHUB_IMAGE"
          
          # Docker Hub에 푸시
          docker push "$DOCKERHUB_IMAGE"
          
          echo "✅ Docker Hub에 이미지 푸시 완료: $DOCKERHUB_IMAGE"
      # ============================================

      - name: Generate docker-compose.yml
        run: |
          cat > docker-compose.yml <<'EOF'
          version: "3.8"
          services:
            sandboxdocker:
              image: evolve1/sandboxdocker:latest
              container_name: sandboxdocker
              restart: always
              tty: true
              working_dir: /root/ext_volume
              environment:
                INTERNAL_LLM_API_BASE: "http://host.docker.internal:11434/v1"
                INTERNAL_LLM_API_KEY: "dev-key"
              volumes:
                - ${HOME}:/root/ext_volume
                # ★ 호스트 Docker 데몬 소켓 공유 (DoD 핵심)
                - /var/run/docker.sock:/var/run/docker.sock
              ports:
                - "37910:37910"
                - "37911:37911"
                - "37912:37912"
                - "37913:37913"
                - "37914:37914"
                - "37915:37915"
                - "38010:38010"
                - "38011:38011"
              # ★ Linux에서 host.docker.internal 해석 (Docker 20.10+ 권장)
              extra_hosts:
                - "host.docker.internal:host-gateway"
          EOF

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-latest
          name: build-latest
          make_latest: true
          prerelease: false
          files: |
            sandboxdocker.tar
            docker-compose.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
