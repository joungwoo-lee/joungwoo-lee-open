name: Publish Docker image tar to build branch (with Git LFS)

on:
  push:
    branches: [ main ]
    paths:
      - "sandboxdocker/**"
      - ".github/workflows/build.yml"
  workflow_dispatch:

permissions:
  contents: write  # build 브랜치 푸시 권한

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history for branch ops)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Sanity check (required files exist)
        run: |
          set -euo pipefail
          test -d sandboxdocker || { echo "sandboxdocker/ 폴더가 없습니다."; exit 1; }
          test -f sandboxdocker/docker_requirements.txt || { echo "docker_requirements.txt 없음"; exit 1; }
          test -f sandboxdocker/docker_runs.txt || { echo "docker_runs.txt 없음"; exit 1; }
          ls -la sandboxdocker || true

      - name: Generate Dockerfile automatically from docker_requirements.txt
        working-directory: sandboxdocker
        shell: bash
        run: |
          set -euo pipefail

          REQ_FILE="docker_requirements.txt"
          GEN_DIR=".gen"
          mkdir -p "${GEN_DIR}"

          extract_section() {
            local section="$1"
            awk -v s="$section" '
              BEGIN{ins=0}
              /^\s*\[/{ins = ($0 ~ "\\[" s "\\]"); next}
              ins {
                if ($0 !~ /^\s*#/ && $0 !~ /^\s*$/) print
              }
            ' "${REQ_FILE}" | sed 's/\r$//'
          }

          # 1) 섹션 파싱
          extract_section "apt"  | sed 's/\r$//' > "${GEN_DIR}/apt.list" || true
          extract_section "pip"  | sed 's/\r$//' > "${GEN_DIR}/pip.requirements" || true
          extract_section "runs" | sed 's/\r$//' > "${GEN_DIR}/build.runs" || true

          # 2) 컨테이너 런타임용 run 스크립트
          RUN_STARTUP="${GEN_DIR}/run_startup.sh"
          {
            echo '#!/usr/bin/env bash'
            echo 'set -euo pipefail'
            sed 's/\r$//' docker_runs.txt
            echo ''
            echo 'if [[ $# -gt 0 ]]; then exec "$@"; else exec bash -l; fi'
          } > "${RUN_STARTUP}"
          chmod +x "${RUN_STARTUP}"

          # 3) [runs] 섹션 → 빌드 타임 스크립트
          {
            echo '#!/usr/bin/env bash'
            echo 'set -euo pipefail'
            cat "${GEN_DIR}/build.runs"
          } > "${GEN_DIR}/build.runs.sh"
          chmod +x "${GEN_DIR}/build.runs.sh"

          # 4) Dockerfile 자동 생성
          cat > Dockerfile <<'EOF'
          FROM python:3.11-slim

          ENV DEBIAN_FRONTEND=noninteractive \
              PIP_DISABLE_PIP_VERSION_CHECK=1 \
              PYTHONDONTWRITEBYTECODE=1 \
              PYTHONUNBUFFERED=1

          ARG DOCKER_HOME=/root
          ENV DOCKER_HOME=${DOCKER_HOME}
          ENV PROJECT_DIR=${DOCKER_HOME}/sandboxdocker
          ENV EXT_VOLUME_DIR=${DOCKER_HOME}/ext_volume

          WORKDIR /tmp/build

          COPY .gen/apt.list /tmp/apt.list
          COPY .gen/pip.requirements /tmp/pip.requirements
          COPY .gen/build.runs.sh /tmp/build.runs.sh
          COPY .gen/run_startup.sh /usr/local/bin/run_startup.sh

          RUN set -euo pipefail; \
              apt-get update; \
              if [ -s /tmp/apt.list ]; then \
                xargs -a /tmp/apt.list apt-get install -y --no-install-recommends; \
              fi; \
              rm -rf /var/lib/apt/lists/*

          RUN set -euo pipefail; \
              if [ -s /tmp/pip.requirements ]; then \
                pip3 install --no-cache-dir -r /tmp/pip.requirements; \
              fi

          RUN set -euo pipefail; \
              if [ -s /tmp/build.runs.sh ]; then \
                bash /tmp/build.runs.sh; \
              fi

          RUN mkdir -p "${PROJECT_DIR}" "${EXT_VOLUME_DIR}"
          COPY . "${PROJECT_DIR}"

          VOLUME ["${EXT_VOLUME_DIR}"]
          WORKDIR ${PROJECT_DIR}

          ENTRYPOINT ["/usr/local/bin/run_startup.sh"]
          CMD []
          EOF

      - name: Build Docker image
        run: |
          docker build -t sandboxdocker:latest sandboxdocker

      - name: Save image as tar
        run: |
          docker save sandboxdocker:latest -o sandboxdocker.tar
          ls -lh sandboxdocker.tar

      - name: Enable Git LFS
        run: |
          sudo apt-get update && sudo apt-get install -y git-lfs
          git lfs install
          git lfs track "*.tar"
          git add .gitattributes
          git commit -m "chore: enable LFS for tar" || true

      - name: Publish image tar to build branch
        env:
          TARGET_BRANCH: build
          GITHUB_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          git fetch --prune origin
          BUILD_DIR="$(mktemp -d /tmp/build-worktree-XXXX)"

          if git ls-remote --heads origin "${TARGET_BRANCH}" | grep -q "${TARGET_BRANCH}"; then
            git worktree add -f "${BUILD_DIR}" "origin/${TARGET_BRANCH}"
            cd "${BUILD_DIR}"
            git switch -c "${TARGET_BRANCH}" || git switch "${TARGET_BRANCH}" || true
          else
            git worktree add -B "${TARGET_BRANCH}" "${BUILD_DIR}"
            cd "${BUILD_DIR}"
            git checkout --orphan "${TARGET_BRANCH}"
          fi

          find . -mindepth 1 -maxdepth 1 ! -name .git -exec rm -rf {} +

          cp $GITHUB_WORKSPACE/sandboxdocker.tar ./sandboxdocker.tar

          git add -A
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "publish Docker image tar (LFS) from ${GITHUB_SHA}" || echo "Nothing to commit"
          git push origin HEAD:"${TARGET_BRANCH}" --force

      - name: Show pushed commit
        run: |
          git ls-remote origin build | awk '{print "build branch tip: " $1}'